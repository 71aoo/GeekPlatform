<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.syclover.geekPlatform.dao.ChallengeMapper">

    <!-- 根据 id 查询 -->
    <select id="getByID" resultMap="allColumnsMapper">
        select * from Challenges where id = #{id} and is_del = 0 and hidden =0
    </select>

    <!-- 根据 category id 查询 -->
    <select id="getByCategoryID" resultMap="allColumnsMapper">
        select * from Challenges where category = #{id} and is_del = 0 and hidden =0
    </select>

    <!-- 根据 category name 查询 -->
    <select id="getByCategoryName" resultMap="allColumnsMapper">
        select
            Challenges.id As id,
            Challenges.name As name,
            Challenges.intro As intro,
            Challenges.hint As hint,
            Challenges.score As score,
            Challenges.flag As flag,
            Challenges.author As author,
            Challenges.category As category,
            Challenges.first_blood As first_blood,
            Challenges.is_del As is_del,
            Challenges.created_time As created_time,
            Challenges.updated_time As updated_time
        from
            Challenges,
            Categories
        where
            Challenges.is_del = 0 and
            Challenges.hidden = 0 and
            Challenges.category = Categories.id and
            Categories.name = #{name}
    </select>

    <!-- 根据 Challenge id 修改字段 -->
    <update id="updateByID" parameterType="com.syclover.geekPlatform.entity.Challenge">
        UPDATE
            Challenges
        SET
            name = #{name},
            intro = #{intro},
            hint = #{hint},
            score = #{score},
            flag = #{flag},
            author = #{author.id},
            category = #{category.id},
            first_blood = #{firstBlood},
            updated_time = DATE_FORMAT(NOW(),'%Y-%m-%d %H:%m:%s')
        WHERE
            id = #{id}
    </update>
    
    <!-- 插入一条新的记录 -->
    <insert id="addChallenge" parameterType="com.syclover.geekPlatform.entity.Challenge">
        INSERT INTO
            Challenges (
                name,
                intro,
                hint,
                score,
                flag,
                author,
                category,
                hidden
                )
        VALUES(
            #{name},
            #{intro},
            #{hint},
            #{score},
            #{flag},
            #{author.id},
            #{category.id},
            #{hidden}
            )
    </insert>
    
    <!-- 根据 id 逻辑删除一个 challenge -->
    <update id="logicallyDelByID" parameterType="com.syclover.geekPlatform.entity.Challenge">
        UPDATE
            Challenges
        SET
            is_del = 1
        WHERE
            id = #{id}
    </update>


    <!-- 所有字段 -->
    <resultMap id="allColumnsMapper" type="com.syclover.geekPlatform.entity.Challenge">
        <result column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="intro" property="intro"/>
        <result column="hint" property="hint"/>
        <result column="score" property="score"/>
        <result column="flag" property="flag"/>
        <result column="hidden" property="hidden"/>
        <result column="first_blood" property="firstBlood"/>
        <result column="is_del" property="isDel"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <association property="author" column="author"
                     javaType="com.syclover.geekPlatform.entity.Author"
                     select="com.syclover.geekPlatform.dao.AuthorMapper.getById">

        </association>
        <association property="category" column="category"
                     javaType="com.syclover.geekPlatform.entity.Category"
                     select="com.syclover.geekPlatform.dao.CategoryMapper.getById">

        </association>
    </resultMap>

</mapper>